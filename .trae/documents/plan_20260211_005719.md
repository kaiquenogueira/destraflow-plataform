# Plano de Implementação: Automação de Infraestrutura Multi-Tenant

A análise confirmou que atualmente o sistema **não garante** a criação automática das tabelas. O processo atual é manual: o admin cadastra a URL e depois precisa rodar um script no terminal.

Para resolver isso e garantir que todo novo usuário tenha a estrutura correta, implementaremos a automação da sincronização do banco de dados diretamente no fluxo de cadastro.

## 1. Diagnóstico Atual
*   **Cadastro**: A função `createUser` em `src/actions/admin.ts` apenas salva a `databaseUrl` criptografada.
*   **Infraestrutura**: As tabelas (`Lead`, `Campaign`, etc.) não são criadas automaticamente.
*   **Sincronização**: Existe um script `scripts/sync-tenants.ts` que faz isso, mas ele precisa ser rodado manualmente pelo desenvolvedor/admin via terminal.

## 2. Solução Proposta
Vamos integrar a lógica de "Push do Schema" diretamente na aplicação administrativa.

### Passo 1: Criar Server Action de Sincronização
Criar uma nova ação `syncTenantDatabase(userId: string)` em `src/actions/admin.ts` (ou novo arquivo dedicado) que:
1.  Busca a `databaseUrl` do usuário.
2.  Executa o comando `prisma db push` programaticamente direcionado a esse banco.
3.  Retorna sucesso ou erro para a UI.

### Passo 2: Automatizar no Cadastro
Modificar a função `createUser` para chamar essa sincronização imediatamente após o registro bem-sucedido.
*   *Nota*: Se a sincronização falhar (ex: banco offline), o usuário será criado mas receberá um aviso, permitindo tentar novamente depois.

### Passo 3: Interface de Gerenciamento (UI)
Adicionar um botão **"Sincronizar Banco de Dados"** na tela de detalhes do usuário (`/admin/users/[id]`).
Isso permite:
*   Corrigir usuários criados anteriormente.
*   Atualizar o banco do usuário quando houver novas funcionalidades/tabelas no sistema.

## 3. Detalhes Técnicos
*   Utilizaremos o comando `npx prisma db push --skip-generate` executado via `child_process.exec`, injetando a `DATABASE_URL` do cliente especificamente para aquela execução.
*   Isso garante que as tabelas `Lead`, `Campaign`, `CampaignMessage`, etc., sejam criadas no banco do cliente sem afetar o banco principal.

## 4. Benefícios
*   **Garantia de Integridade**: Todo usuário criado terá as tabelas necessárias.
*   **Autonomia**: O Admin não precisa mais acesso ao terminal para "ativar" um cliente.
*   **Manutenibilidade**: Atualizações futuras do schema podem ser propagadas clicando em um botão na UI.
